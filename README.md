# Telegram-бот для итогов игрового дня (теннис)

Бот собирает завершённые матчи турнира с Flashscore и формирует сообщение в вашем формате, 
а также генерирует плашки в фирменном стиле по указанным матчам.

## Быстрый старт

1. **Python 3.11+**
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Создайте `.env` по образцу `.env.example` и впишите токен бота.
4. Запустите:
   ```bash
   python -m bot.bot
   ```

> Бот использует московский часовой пояс по умолчанию — можно изменить переменной `TZ`.

## Команды

- `/set <ссылка_на_турнир_Flashscore>` — сохранить страницу турнира (можно мобильную `https://m.flashscorekz.com/...`).
- `/today` — прислать текст сообщения «Результаты игрового дня» на основе завершённых матчей.
- `/plaque` — в **том же сообщении** ниже или реплаем пришлите список строк
  вида `Игрок1 — Игрок2` (каждая с новой строки). Бот пришлёт плашки для найденных матчей.
- `/subscribe HH:MM` — ежедневная автопубликация итогов в указанное время (локальное для TZ).

## Формат сообщения

Формируется автоматически на основе матча и простой эвристики категорий: 
«Сенсации», «Ожидаемо», «Когда шансы 50/50». Логику можно доработать в
`bot/modules/formatter.py` (функция `naive_categorize`). Также можно добавить ручные
переопределения через команду/меню — места в БД уже предусмотрены (`overrides`), 
но обработчик можно подключить по вашему ТЗ.

## Плашки

Генератор плашек — `bot/plaque.py`. В качестве фона используется шаблон
`assets/plaque_template.png` (в комплекте пример). Цвета/шрифты задаются в `bot/config.py`.

Если вы хотите пиксель-в-пиксель стиль, положите ваши шрифты и пропишите пути:
```env
FONT_BOLD=/path/to/Manrope-ExtraBold.ttf
FONT_REGULAR=/path/to/Manrope-Regular.ttf
```

Функция `render_plaque(player1, player2, sets, tournament_line)` возвращает `PIL.Image`,
которую бот отправляет как изображение.

## Как устроен парсинг

Модуль `bot/flashscore.py` делает HTTP-запрос к странице турнира (десктоп или мобильной версии),
распознаёт карточки завершённых матчей и вытаскивает пары/счёт. Разметка Flashscore иногда меняется,
поэтому в модуле предусмотрены «устойчивые» селекторы и несколько запасных стратегий. 
Если на конкретной странице ничего не находится — проверьте селекторы и заголовки блоков.

### Советы по стабильности

- Лучше указывать **мобильную** ссылку на турнир: `https://m.flashscorekz.com/tennis/...` — HTML проще.
- При необходимости можно заменить парсинг на Selenium/undetected-chromedriver — архитектура бота не меняется.
- Если нужен потоковый режим (реакция сразу по окончании матча) — добавьте периодический опрос страницы 
  каждые N минут и фиксируйте уже обработанные `Match.key` (ид матча).

## Развёртывание

- Для простоты — systemd + venv.
- Можно добавить Dockerfile при необходимости.

Примеры команд:

```
/set https://m.flashscorekz.com/tennis/atp-singles/paris/results/
/today
/plaque
Рублёв — Тьен
Медведев — Мунар
```

Удачи! Если нужно — доработаю под ваш конкретный шаблон и логику категоризации.
